/*
	Copyright (c) 2004-2010, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["modulo.gestao.timeline"]){dojo._hasResource["modulo.gestao.timeline"]=true;dojo.require("modulo.padrao.geral");dojo.require("modulo.padrao.grid");dojo.provide("modulo.gestao.timeline");dojo.declare("modulo.gestao.timeline",[modulo.padrao.geral,modulo.padrao.grid],{constructor:function(){},load:0,lightbox:0,initScheduler:function(){objGeral.loading(true);scheduler.config.icons_edit=["icon_cancel"];scheduler.config.icons_select=["icon_details"];scheduler.config.multi_day=true;scheduler.config.mark_now=true;scheduler.config.xml_date="%Y-%m-%d %H:%i";scheduler.config.details_on_dblclick=true;scheduler.config.details_on_create=true;scheduler.attachEvent("onClick",function(_1,ev){gestaoTimeline.idEventSel=_1;});scheduler.attachEvent("onEventChanged",function(_2,ev){if(confirm(objGeral.translate("Deseja salvar alterações do evento?"))){gestaoTimeline.changeEventSave(_2,ev);}else{gestaoTimeline.atualizarGrid();}});scheduler.templates.tooltip_text=function(_3,_4,_5){return _5.text+"<br/><b>"+objGeral.translate("Início")+":</b> "+scheduler.templates.tooltip_date_format(_3)+"<br/><b>"+objGeral.translate("Fim")+":</b> "+scheduler.templates.tooltip_date_format(_4);};scheduler.templates.tooltip_date_format=scheduler.date.date_to_str("%d/%m/%Y %H:%i");scheduler.init("scheduler_here",null,"week");scheduler.showLightbox=function(_6){gestaoTimeline.lightbox=_6;var ev=scheduler.getEvent(_6);gestaoTimeline.novo(ev);};gestaoTimeline.initFilterProjeto();gestaoTimeline.atualizarGrid();objGeral.loading(false);},novo:function(ev){this.url="/gestao/timeline/";this.title=objGeral.translate("Timeline");if(ev){this.url+=ev.data?("edit/id/"+ev.data.timeline_id):"form";this.dialog=objGeral.createDialog(this.url,this.title,function(){if(!ev.data){dijit.byId("dt_inicio").set("value",ev.start_date);dijit.byId("hr_inicio").set("value",ev.start_date);dijit.byId("dt_fim").set("value",ev.end_date);dijit.byId("hr_fim").set("value",ev.end_date);}});}else{this.url="/gestao/timeline/form";this.dialog=objGeral.createDialog("/gestao/timeline/form",this.title);}dojo.connect(gestaoTimeline.dialog,"hide",function(){gestaoTimeline.atualizarGrid();});},atualizarGrid:function(){if(this.load==0){var _7=dijit.byId("projeto_filtro_id").get("value");if(gestaoTimeline.lightbox!=0){scheduler.startLightbox(gestaoTimeline.lightbox,null);scheduler.endLightbox(false,null);gestaoTimeline.lightbox=0;}objGeral.loading(true);gestaoTimeline.load=1;scheduler.clearAll();scheduler.load(baseUrl+"/gestao/timeline/list/id/"+_7,"json",dojo.hitch(gestaoTimeline,"fimAtualizarGrid"));}},edit:function(){if(!this.idEventSel){objGeral.msgAlerta(objGeral.translate("Selecione o item para edição."));return false;}this.title=objGeral.translate("Timeline");this.url="/gestao/timeline/edit/id/"+this.idEventSel;var _8=objGeral.createDialog(this.url,this.title);dojo.connect(_8,"hide",function(){gestaoTimeline.atualizarGrid();});return false;},fimAtualizarGrid:function(){gestaoTimeline.load=0;objGeral.loading(false);},getCargaHoraria:function(id){if(id){var _9={url:baseUrl+"/gestao/timeline/carga-horaria",data:{id:id},handle:"json",callback:function(_a){dijit.byId("timeline_carga_horaria").set("value",_a.funcionario_carga_diaria);}};objGeral.buscaAjax(_9);}},changeFuncionario:function(){var _b=["dt_inicio","dt_fim"];var _c=parseInt(dijit.byId("projeto_id").get("value"));var _d=parseInt(dijit.byId("funcionario_id").get("value"));if(_c&&_d){var _e={url:baseUrl+"/gestao/timeline/periodo",data:{funcionario_id:_d,projeto_id:_c},handle:"json",callback:function(_f){for(i in _b){dijit.byId(_b[i]).set("readOnly",false);}dojo.mixin(dijit.byId("dt_inicio").constraints,{min:dojo.date.stamp.fromISOString(_f.dt_inicio),max:dojo.date.stamp.fromISOString(_f.dt_fim)});dojo.mixin(dijit.byId("dt_fim").constraints,{min:dojo.date.stamp.fromISOString(_f.dt_inicio),max:dojo.date.stamp.fromISOString(_f.dt_fim)});}};objGeral.buscaAjax(_e);dojo.connect(dijit.byId("dt_inicio"),"onChange",function(_10){dojo.mixin(dijit.byId("dt_fim").constraints,{min:_10});});dojo.connect(dijit.byId("dt_fim"),"onChange",function(_11){dojo.mixin(dijit.byId("dt_inicio").constraints,{max:_11});});}else{for(i in _b){dijit.byId(_b[i]).set("readOnly",true);dijit.byId(_b[i]).constraints={};}}},lancamento:function(){var _12=objGeral.createDialog("/gestao/timeline/lancamento/",objGeral.translate("Lançamento"),gestaoTimeline.initGridLancamento);},setConstraintDataIniFimLanc:function(){var _13=dijit.byId("funcionario_id").get("value");dijit.byId("lanc_dt_inicio").set("value","");dijit.byId("lanc_dt_fim").set("value","");if(objGeral.empty(_13)){dijit.byId("lanc_dt_inicio").set("readOnly",true);dijit.byId("lanc_dt_fim").set("readOnly",true);}else{dijit.byId("lanc_dt_inicio").set("readOnly",false);dijit.byId("lanc_dt_fim").set("readOnly",false);return false;var obj={url:baseUrl+"/gestao/timeline/maxmimatividades",data:{funcionario_id:_13},handle:"json",error:function(){objGeral.msgErro(objGeral.translate("Erro ao executar operação"));},callback:function(_14){if(_14.result){dijit.byId("lanc_dt_inicio").attr("readOnly",false);dijit.byId("lanc_dt_fim").attr("readOnly",false);dojo.mixin(dijit.byId("lanc_dt_inicio").constraints,{min:dojo.date.stamp.fromISOString(_14.min),max:dojo.date.stamp.fromISOString(_14.max)});dojo.mixin(dijit.byId("lanc_dt_fim").constraints,{min:dojo.date.stamp.fromISOString(_14.min),max:dojo.date.stamp.fromISOString(_14.max)});}else{dijit.byId("lanc_dt_inicio").set("readOnly",false);dijit.byId("lanc_dt_fim").set("readOnly",false);objGeral.msgErro(objGeral.translate("Erro ao executar operação"));}}};objGeral.buscaAjax(obj);}},setConstraintMinLanc:function(){var _15=dijit.byId("lanc_dt_inicio").get("value");if(_15){dojo.mixin(dijit.byId("lanc_dt_fim").constraints,{min:_15});}},setConstraintMaxLanc:function(){var _16=dijit.byId("lanc_dt_fim").get("value");if(_16){dojo.mixin(dijit.byId("lanc_dt_inicio").constraints,{max:_16});}},listaLancamentos:function(){var _17=dijit.byId("form-gestao-timeline-lancamento");if(_17.isValid()){gestaoAtividade.grid.clearAll();var _18={funcionario_id:dijit.byId("funcionario_id").get("value"),dt_inicio:objGeral.formateDate(dijit.byId("lanc_dt_inicio").get("value")),dt_fim:objGeral.formateDate(dijit.byId("lanc_dt_fim").get("value"))};var obj={url:baseUrl+"/gestao/timeline/lista-lancamentos",data:_18,handle:"json",error:function(){objGeral.msgErro(objGeral.translate("Erro ao executar operação"));},callback:function(_19){gestaoAtividade.grid.parse(_19,"json");}};objGeral.buscaAjax(obj);}},initGridLancamento:function(){objGeral.loading(true);gestaoAtividade.gridHeader=objGeral.translate("Projeto")+","+objGeral.translate("Atividade")+","+objGeral.translate("Horas Trabalhadas")+",#cspan,"+objGeral.translate("Salário");document.getElementById("gridGestaoTimelineLancamento").style.height=objGrid.gridHeight+"px";gestaoAtividade.grid=new dhtmlXGridObject("gridGestaoTimelineLancamento");gestaoAtividade.grid.setHeader(gestaoAtividade.gridHeader);gestaoAtividade.grid.attachHeader("#text_filter,#text_filter,#text_filter,,#text_filter");gestaoAtividade.grid.setInitWidths("*,100,100,100,100");gestaoAtividade.grid.setColAlign("left,left,left,left,left");gestaoAtividade.grid.setColTypes("ro,ro,ro,ro,ro");gestaoAtividade.grid.setColSorting("str,str,str,str,str");gestaoAtividade.grid.setSkin(objGrid.theme);gestaoAtividade.grid.enablePaging(true,objGrid.pagResults,objGrid.pagIndexes,"divpagGestaoTimelineLancamentoGrid",true,"divpagGestaoTimelineLancamentoGrid");gestaoAtividade.grid.attachFooter(objGrid.tituloTotal+",#cspan,#cspan,#cspan,{#stat_count}");gestaoAtividade.grid.init();objGeral.loading(false);},custo:function(){objGeral.createDialog("/gestao/timeline/custo/",objGeral.translate("Custo"));},calcularCusto:function(){var _1a=dijit.byId("form-gestao-timeline-custo");if(_1a.isValid()){var obj={url:baseUrl+"/gestao/timeline/calcular-custo",data:{funcionario_id:dijit.byId("funcionario_id").get("value"),qtd_dias:dojo.date.difference(dijit.byId("dt_inicio").get("value"),dijit.byId("dt_fim").get("value"),"day")},handle:"json",callback:function(_1b){dijit.byId("custo").set("value",_1b.custo);dijit.byId("carga_horaria").set("value",_1b.carga_horaria);}};objGeral.buscaAjax(obj);}else{objGeral.msgErro(objGeral.translate("Informe os dados corretamente!"));}},loadFuncionario:function(_1c){if(_1c){objGeral.changeFilteringSelect("funcionario_id",baseUrl+"/gestao/timeline/funcionario/projeto_id/",_1c);}else{dijit.byId("funcionario_id").set("value","0");dijit.byId("funcionario_id").set("disabled",true);}},changeEventSave:function(_1d,ev){if(_1d){var _1e={timeline_id:_1d,dt_inicio:objGeral.formateDate(ev.start_date),hr_inicio:objGeral.formateDate(ev.start_date,"h:m:s"),dt_fim:objGeral.formateDate(ev.end_date),hr_fim:objGeral.formateDate(ev.end_date,"h:m:s")};var obj={url:baseUrl+"/gestao/timeline/change-event-save",data:_1e,handle:"json",error:function(){objGeral.msgErro(objGeral.translate("Erro ao executar operação"));},callback:function(_1f){if(_1f.result){objGeral.msgSucesso(objGeral.translate("Operação realizada com sucesso."));}else{objGeral.msgErro(objGeral.translate("Erro ao executar operação"));}}};objGeral.buscaAjax(obj);}},initFilterProjeto:function(){objGeral.loading(true);var _20=new dojo.data.ItemFileReadStore({url:baseUrl+"/gestao/timeline/projetos/"});_20.fetch({onComplete:function(){objGeral.loading(false);}});var _21=new dijit.form.FilteringSelect({store:_20,id:"projeto_filtro_id",onChange:function(){gestaoTimeline.atualizarGrid();}});$(dijit.byId("buttonlancamentotimeline").domNode).after($(_21.domNode));}});var gestaoTimeline=new modulo.gestao.timeline();}