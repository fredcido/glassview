/*
	Copyright (c) 2004-2010, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["modulo.financeiro.lancamentocartao"]){dojo._hasResource["modulo.financeiro.lancamentocartao"]=true;dojo.require("modulo.padrao.geral");dojo.require("modulo.padrao.grid");dojo.provide("modulo.financeiro.lancamentocartao");dojo.declare("modulo.financeiro.lancamentocartao",[modulo.padrao.geral,modulo.padrao.grid],{gridLancamentosPendentes:null,gridLancamentosEfetivados:null,liberaDragDrop:false,dadosEfetivar:null,tiposLancamentosAgrupados:null,constructor:function(){this.noChangeTipoLancamento=false;this.noDoubleClickTree=null;},initGrid:function(){objGeral.loading(true);financeiroLancamentoCartao.gridHeader="#,"+objGeral.translate("Data")+","+objGeral.translate("Cartão de Crédito")+","+objGeral.translate("Descrição")+","+objGeral.translate("Valor")+","+objGeral.translate("Status");document.getElementById("gridFinanceiroLancamentoCartao").style.height=objGrid.gridHeight+"px";financeiroLancamentoCartao.grid=new dhtmlXGridObject("gridFinanceiroLancamentoCartao");financeiroLancamentoCartao.grid.setHeader(financeiroLancamentoCartao.gridHeader);financeiroLancamentoCartao.grid.attachHeader("#rspan,#text_filter,#select_filter,#text_filter,#text_filter,#select_filter");financeiroLancamentoCartao.grid.setInitWidths(objGrid.idWidth+",80,220,*,110,100");financeiroLancamentoCartao.grid.setColAlign("center,left,left,left,left,left");financeiroLancamentoCartao.grid.setColTypes("ro,ro,ro,ro,ro,ro");financeiroLancamentoCartao.grid.setColSorting("str,date,str,str,str,str");financeiroLancamentoCartao.grid.setCustomSorting(dojo.hitch(objGeral,"sortCurrency"),3);financeiroLancamentoCartao.grid.setSkin(objGrid.theme);financeiroLancamentoCartao.grid.enablePaging(true,objGrid.pagResults,objGrid.pagIndexes,"divpagFinanceiroLancamentoCartaoGrid",true,"divpagfinanceiroLancamentoCartao");financeiroLancamentoCartao.grid.attachFooter(objGrid.tituloTotal+",#cspan,#cspan,#cspan,{#stat_total},{#stat_count}");financeiroLancamentoCartao.grid.attachEvent("onRowDblClicked",financeiroLancamentoCartao.edit);financeiroLancamentoCartao.grid.init();financeiroLancamentoCartao.grid.load(baseUrl+"/financeiro/lancamento-cartao/list",dojo.hitch(objGeral,"loading",false),"json");},novo:function(){objGeral.createDialog("/financeiro/lancamento-cartao/form/",objGeral.translate("Lançamentos Cartão"));},edit:function(){if(!financeiroLancamentoCartao.grid.getSelectedId()){objGeral.msgAlerta(objGeral.translate("Selecione o item para edição."));return false;}objGeral.createDialog("/financeiro/lancamento-cartao/edit/id/"+financeiroLancamentoCartao.grid.getSelectedId(),objGeral.translate("Cartão de Credito"));return true;},atualizarGrid:function(){objGeral.atualizarGrids([financeiroLancamentoCartao.grid]);},filteringTipoLancamento:function(_1){var _2=parseInt($(_1).attr("id").replace(/^[a-zA-Z_]+/g,""));dijit.byId("tipolan_"+_2).attr("value","");document.getElementById("vltplan_"+_2).value="";},addTipoLancamento:function(){objGeral.loading(true);var _3=this.geraHashId();var _4=$("<td />");var _5=$("<td />");var _6=$("<td />");var _7=$("<td />");var _8=$("<td />");var tr=$("<tr />");var _9=new dojo.data.ItemFileReadStore({url:baseUrl+"/financeiro/lancamento-cartao/tipolancamentolist"});var _a=new dijit.form.ValidationTextBox({name:"text_lancamento[]",id:"tipolan_"+_3,required:true,onChange:function(){financeiroLancamentoCartao.setChangeTipoLancamento(this);},style:"width: 230px;",labelAttr:"label",labelType:"html"});dojo.connect(_a,"onChange",null,function(){financeiroLancamentoCartao.validaTipoLancamentoTala(_a);});var _b=document.createElement("input");_b.type="hidden";_b.name="fn_tipo_lanc_id[]";_b.id="vltplan_"+_3;var _c=new dijit.form.Button({id:"buttonn_"+_3,onClick:function(){financeiroLancamentoCartao.changeTipoLancamento(this);},iconClass:"icon-toolbar-applicationformmagnify"});var _d=new dojo.data.ItemFileReadStore({url:baseUrl+"/financeiro/lancamento-cartao/projetolist"});var _e=new dijit.form.FilteringSelect({name:"projeto_id[]",store:_d,id:"projeto_"+_3,style:"width: 230px;",labelAttr:"label",labelType:"hmtl",onChange:function(_f){var _10=parseInt($(this).attr("id").replace(/^[a-zA-Z_]+/g,""));dijit.byId("tipolan_"+_10).attr("value","");document.getElementById("vltplan_"+_10).value="";}});var _11=new dijit.form.CurrencyTextBox({name:"fn_lanc_cc_tipo_valor[]",style:"width: 230px;",id:"valorpr_"+_3,required:true,currency:"R$ ",value:0});dojo.connect(_11,"onChange",null,function(){financeiroLancamentoCartao.somaLancamentos(_11);});_4.append(_e.domNode);_5.append(_a.domNode);_5.append(_b);_6.append(_c.domNode);_7.append(_11.domNode);var _12=$("<div />");_12.addClass("icon-toolbar-cancel").click(function(){if(!confirm(objGeral.translate("Deseja realmente remover este item?"))){return false;}objGeral.deleteRow($(this).parent().parent());return true;}).attr("title",objGeral.translate("Remover Lançamento")).css("cursor","pointer");_8.append(_12);tr.append(_4).append(_5).append(_6).append(_7).append(_8);$("#tbl-lancamento-tipo").append(tr);_9.fetch({onComplete:function(){dijit.byId(_a.id).focus();}});_d.fetch({onComplete:function(){objGeral.loading(false);dijit.byId(_e.id).focus();}});},validaTipoLancamentoTala:function(obj){if(!objGeral.empty(obj.value)){objGeral.loading(true);var _13=dojo.xhrPost({form:"formfinanceirolancamentocartao",handleAs:"json",url:baseUrl+"/financeiro/lancamento-cartao/valida-tipo-lancamento",load:function(_14){objGeral.loading(false);if(!_14.validacao){obj.value="";obj.displayedValue="";objGeral.msgAlerta(objGeral.translate("Tipo de lançamento duplicado."));}},error:function(_15){objGeral.msgErro(objGeral.translate("Erro ao executar operação"));}});}},somaLancamentos:function(obj){objGeral.loading(true);var _16=dojo.xhrPost({form:"formfinanceirolancamentocartao",handleAs:"json",url:baseUrl+"/financeiro/lancamento-cartao/soma-lancamento",load:function(_17){objGeral.loading(false);dijit.byId("fn_lanc_cartao_valor").attr("value",_17.total);},error:function(_18){objGeral.msgErro(objGeral.translate("Erro ao executar operação"));}});},removeTipoLancamentoTela:function(_19,_1a,img){if(!confirm(objGeral.translate("Deseja realmente remover este item?"))){return false;}objGeral.deleteRow($(img).parent().parent());this.somaLancamentos();return true;},reconciliar:function(){objGeral.createDialog("/financeiro/lancamento-cartao/reconciliar/",objGeral.translate("Reconciliação de Cartão de Crédito"),dojo.hitch(this,"initGridReconciliacao"));},initGridReconciliacao:function(){gridHeader=objGeral.translate("Descrição")+","+objGeral.translate("Valor")+","+objGeral.translate("Data");this.gridLancamentosPendentes=new dhtmlXGridObject("lancamentos-pendentes");with(this.gridLancamentosPendentes){setHeader(objGeral.translate("Lançamentos pendentes")+",#cspan,#cspan",null,["text-align:center;"]);attachHeader(gridHeader);setInitWidths("*,100,100");setColAlign("left,left,left");setMultiLine(false);setColTypes("ro,ro,ro");setColSorting("str,na,date");enableDragAndDrop(true);setCustomSorting(dojo.hitch(objGeral,"sortCurrency"),1);attachEvent("onDrop",dojo.hitch(this,"controlDropGrid"));attachEvent("onBeforeDrag",dojo.hitch(this,"blockDropGrid"));setSkin(objGrid.theme);attachFooter(objGrid.tituloTotal+",{#stat_total},{#stat_count}");init();}this.gridLancamentosEfetivados=new dhtmlXGridObject("lancamentos-efetivados");with(this.gridLancamentosEfetivados){setHeader(objGeral.translate("Lançamentos efetivados")+",#cspan,#cspan",null,["text-align:center;"]);attachHeader(gridHeader);setInitWidths("*,100,100");setColAlign("left,left,left");setMultiLine(false);setColTypes("ro,ro,ro");setColSorting("str,na,date");enableDragAndDrop(true);setCustomSorting(dojo.hitch(objGeral,"sortCurrency"),1);attachEvent("onDrop",dojo.hitch(this,"controlDropGrid"));setSkin(objGrid.theme);attachFooter(objGrid.tituloTotal+",{#stat_total},{#stat_count}");init();}this.liberaDropGrid(false);},blockDropGrid:function(){return this.liberaDragDrop;},controlDropGrid:function(){var _1b=objGeral.empty(this.gridLancamentosEfetivados.getRowsNum());dijit.byId("buttonEfetivarReconciliacaoCartao").setDisabled(_1b);dijit.byId("fn_cc_fat_total").set("readOnly",!_1b);return true;},buscaLancamentos:function(){var _1c=dijit.byId("fn_cc_id").get("value");if(objGeral.empty(_1c)){return false;}var _1d=this;var obj={url:baseUrl+"/financeiro/lancamento-cartao/busca-lancamentos/cartao/"+_1c,handle:"json",callback:function(_1e){_1d.gridLancamentosPendentes.clearAll();_1d.gridLancamentosPendentes.parse(_1e.lancamentos,"json");if(objGeral.empty(_1e.fatura)){dijit.byId("fn_cc_fat_total").set("readOnly",false).set("value","").focus();}else{dijit.byId("formFinanceiroReconciliacaoCartao").getDescendants().forEach(function(_1f){_1f.set("readOnly",false).focus();});dijit.byId("formFinanceiroReconciliacaoCartao").setValues(_1e.fatura);with(dijit.byId("fn_cc_fat_total")){focus();blur();set("readOnly",true);}dijit.byId("buttonSalvarReconciliacaoCartao").focus();_1d.gridLancamentosEfetivados.clearAll();_1d.gridLancamentosEfetivados.parse(_1e.efetivados,"json");_1d.liberaMovimentacao();dijit.byId("buttonEfetivarReconciliacaoCartao").setDisabled(false);}}};objGeral.buscaAjax(obj);return true;},liberaDropGrid:function(_20){this.liberaDragDrop=Boolean(_20);},liberaMovimentacao:function(){var _21=dijit.byId("fn_cc_fat_total").get("value");this.liberaDropGrid(_21);dijit.byId("fn_cc_fat_ref").set("readOnly",objGeral.empty(_21));dijit.byId("fn_cc_fat_vencimento").set("readOnly",objGeral.empty(_21));if(objGeral.empty(_21)){dijit.byId("fn_cc_fat_ref").set("value",null);dijit.byId("fn_cc_fat_vencimento").set("value",null);}},validarReconciliacao:function(_22){if(!_22.validate()){this.msgErro(objGeral.translate("Verifique todos os campos marcados antes de continuar."));return false;}if(objGeral.empty(this.gridLancamentosEfetivados.getRowsNum())){this.msgErro(objGeral.translate("Não existem lançamentos efetivados."));return false;}return true;},salvarReconciliacao:function(_23){var _24=dijit.byId(_23);if(!this.validarReconciliacao(_24)){return false;}var _25=this.gridLancamentosEfetivados.getAllRowIds(",");var obj={url:baseUrl+"/financeiro/lancamento-cartao/salvar-reconciliacao/",data:{"lancamentos[]":_25.split(",")},handle:"json",callback:function(_26){if(_26.status){dojo.byId("fn_cc_fat_id").value=_26.fatura;objGeral.msgSucesso(objGeral.translate("Operação realizada com sucesso."));}else{objGeral.msgErro(objGeral.translate("Erro ao salvar fatura."));}},form:dojo.byId(_23)};objGeral.buscaAjax(obj);return true;},clearDataEfetivar:function(){this.dadosEfetivar=null;},efetivarReconciliacao:function(_27){this.clearDataEfetivar();var _28=dijit.byId(_27);if(!this.validarReconciliacao(_28)){return false;}var _29=dijit.byId("fn_cc_fat_total").get("value");var _2a=0;this.gridLancamentosEfetivados.forEachRow(function(id){_2a+=objGeral.toFloat(this.cells(id,1).getValue());});_2a=_2a.toFixed(2);if(_29!=_2a){this.msgAlerta(objGeral.translate("Total da fatura não confere com o total efetivado."));return false;}var _2b=this.gridLancamentosEfetivados.getAllRowIds(",");this.dadosEfetivar={"lancamentos[]":_2b.split(","),total:objGeral.toFloat(_2a),cartao:dijit.byId("fn_cc_id").get("displayedValue"),ref:dijit.byId("fn_cc_fat_ref").get("displayedValue"),fn_cc_fat_id:dojo.byId("fn_cc_fat_id").value};this.dadosEfetivar=dojo.safeMixin(this.dadosEfetivar,_28.getValues());this.dadosEfetivar.fn_cc_fat_vencimento=this.formateDate(this.dadosEfetivar.fn_cc_fat_vencimento);var _2c=this;var obj={url:baseUrl+"/financeiro/lancamento-cartao/verifica-permissao-efetivar/",handle:"json",callback:function(_2d){if(!_2d.permissao){objGeral.msgErro(objGeral.translate("Usuário sem permissão para efetivar fatura."));_2c.clearDataEfetivar();}else{_2c.criarLancamento(_27);}},callbackError:function(_2e){objGeral.msgErro(objGeral.translate("Usuário sem permissão para efetivar fatura."));_2c.clearDataEfetivar();}};objGeral.buscaAjax(obj);return true;},criarLancamento:function(_2f){var _30=this;var obj={url:baseUrl+"/financeiro/lancamento-cartao/prepara-fatura-lancamento/",handle:"json",data:this.dadosEfetivar,callback:function(_31){_30.tiposLancamentosAgrupados=_31;dojo.byId("fn_cc_fat_id").value=_31.fatura;objGeral.createDialog("/financeiro/lancamento/form/",objGeral.translate("Lançamento"),dojo.hitch(_30,"preparaLancamentoFatura"));},form:dojo.byId(_2f)};objGeral.buscaAjax(obj);},preparaLancamentoFatura:function(){dijit.byId("lancamento-fn_lancamento_tipo").set("value","D").set("readOnly",true);dijit.byId("lancamento-fn_lancamento_status").set("value","A").set("readOnly",true);dijit.byId("lancamento-tela").set("readOnly",true);dijit.byId("lancamento-fn_lancamento_efetivado").set("disabled",false).set("checked",true).set("readOnly",true);dijit.byId("lancamento-fn_lancamento_valor").set("value",this.dadosEfetivar.fn_cc_fat_total);var obs="Efetivação fatura "+this.dadosEfetivar.cartao+" Ref.: "+this.dadosEfetivar.ref;dijit.byId("lancamento-fn_lancamento_obs").set("value",obs).set("readOnly",true);divElement=$("<div />");divElement.addClass("element");label=$("<label />");label.attr("for","fn_lancamento_dtefetivado").addClass("required").html("Dt. Efetivação");divElement.append(label);spanInput=$("<span />");spanInput.addClass("input");if(dijit.byId("fn_lancamento_dtefetivado")){dijit.byId("fn_lancamento_dtefetivado").destroy();}dateEfetivacao=new dijit.form.DateTextBox({name:"fn_lancamento_dtefetivado",id:"fn_lancamento_dtefetivado",required:true,value:new Date()});spanInput.append(dateEfetivacao.domNode);divElement.append(spanInput);dijit.byId("valor_cheque").destroy();$("label[for=valor_cheque]").closest("div.element").replaceWith(divElement);dijit.byId("btn_cheque").destroy();$(".icon-toolbar-add").parent().remove();dijit.byId("financeiro_lancamento_salvar").onClick=null;dojo.connect(dijit.byId("financeiro_lancamento_salvar"),"onClick",dojo.hitch(this,"salvaLancamento"));this.criaElementosLancamento(this.tiposLancamentosAgrupados.itens);},criaElementosLancamento:function(_32){objGeral.loading(true);dojo.forEach(_32,function(_33){var tr=$("<tr />").appendTo($("#tbl-lancamento-tipo"));var _34=$("<input />").attr({type:"hidden",name:"lancamento[projeto_id][]",value:_33.projeto_id});tr.append($("<td />").append(_34).append(_33.projeto_nome));var _35=$("<input />").attr({type:"hidden",name:"lancamento[fn_tipo_lanc_id][]",value:_33.fn_tipo_lanc_id});tr.append($("<td />").append(_35).append(_33.fn_tipo_lanc_desc));var _36=$("<input />").attr({type:"hidden",name:"lancamento[fn_lanc_projeto_valor][]",value:_33.total});tr.append($("<td />").append(_36).append(dojo.currency.format(parseFloat(_33.total),{currency:"R$",locale:"pt-br"})));var _37=$("<div class=\"icon-toolbar-delete\">").css({cursor:"no-drop"});tr.append($("<td />").append(_37));});objGeral.loading(false);},salvaLancamento:function(){var _38="formfinanceirolancamento";var _39=dijit.byId(_38);if(this.validaForm(_39,this)){this.loading(true);var _3a=this;var _3b={url:baseUrl+"/financeiro/lancamento-cartao/efetivar-reconciliacao/",handleAs:"json",content:this.dadosEfetivar,handle:function(){_3a.loading(false);},load:function(_3c){if(_3c.status){_3a.msgSucesso(objGeral.translate("Operação realizada com sucesso."));_3a.closeGenericDialog();_3a.closeGenericDialog();}else{if(_3c.msg){_3a.msgErro(objGeral.translate(_3c.msg));}else{_3a.msgErro(objGeral.translate("Erro ao executar operação"));}}},error:function(){_3a.msgErro(objGeral.translate("Erro ao executar operação"));},form:dojo.byId(_38),timeout:_3a.timeout};dojo.xhrPost(_3b);}},isExistId:function(_3d){if(dojo.byId("projeto_"+_3d)||dojo.byId("buttonn_"+_3d)||dojo.byId("tipolan_"+_3d)||dojo.byId("vltplan_"+_3d)||dojo.byId("valorpr_"+_3d)){return true;}else{return false;}},geraHashId:function(){var _3e=new Date().getTime();while(financeiroLancamentoCartao.isExistId(_3e)){_3e=new Date().getTime();}return _3e;},setValuesTipoLancamento:function(_3f,_40){var _41=_3f.id;_41=_41.toString();if(_41.split("_")[0]!="CAT"){financeiroLancamentoCartao.noChangeTipoLancamento=true;dijit.byId(financeiroLancamentoCartao.idTipoLancText).attr("value",_3f.path);document.getElementById(financeiroLancamentoCartao.idTipoLancValor).value=_3f.id;if(financeiroLancamentoCartao.noDoubleClickTree){objGeral.closeGenericDialog();financeiroLancamentoCartao.noDoubleClickTree=false;}}else{objGeral.msgAlerta(objGeral.translate("Você selecionou uma categoria, você deve selecionar um tipo de lançamento!"));}return true;},initTree:function(){financeiroLancamentoCartao.noDoubleClickTree=true;var _42=dijit.byId(financeiroLancamentoCartao.idProjeto);var id=_42.value;if(!objGeral.empty(this.treeView)){this.treeView.destroyRecursive(true);}objGeral.loading(true);var _43=new dojo.data.ItemFileWriteStore({url:baseUrl+"/financeiro/lancamento-cartao/treetipolancamento/id/"+id,hierarchical:true});_43.fetch({onComplete:function(){objGeral.loading(false);}});var _44=new modulo.custom.ForestStoreModel({store:_43,query:{type:"root"},childrenAttrs:["children"]},"store");this.treeView=new modulo.custom.TreeMenu({model:_44,showRoot:false,persist:true,dragThreshold:8,betweenThreshold:5,dndController:false,customIcons:false});dojo.connect(this.treeView,"onClick",dojo.hitch(financeiroLancamentoCartao,"setValuesTipoLancamento"));dojo.byId("tree-tipo-lancamento").appendChild(this.treeView.domNode);this.treeView.startup();},setChangeTipoLancamento:function(_45){if(financeiroLancamentoCartao.noChangeTipoLancamento){financeiroLancamentoCartao.noChangeTipoLancamento=false;return false;}var _46=_45.id;financeiroLancamentoCartao.idProjeto="projeto_"+parseInt(_46.replace(/^[a-zA-Z_]+/g,""));financeiroLancamentoCartao.idTipoLancText="tipolan_"+parseInt(_46.replace(/^[a-zA-Z_]+/g,""));financeiroLancamentoCartao.idTipoLancValor="vltplan_"+parseInt(_46.replace(/^[a-zA-Z_]+/g,""));var _47=dijit.byId(financeiroLancamentoCartao.idProjeto).attr("value");if(_45.value==""){return false;}if(_47==""){objGeral.msgAlerta(objGeral.translate("Selecione projeto"));dijit.byId(financeiroLancamentoCartao.idTipoLancText).attr("value","");dojo.byId(financeiroLancamentoCartao.idTipoLancValor).value="";return false;}else{objGeral.buscaAjax({url:baseUrl+"/financeiro/lancamentocartao/busca-tipo-lancamento-codigo/",data:{fn_tipo_lanc_cod:_45.value,projeto_id:_47},handle:"json",callback:function(_48){financeiroLancamentoCartao.noChangeTipoLancamento=true;if(_48==null){objGeral.msgAlerta(objGeral.translate("Código de tipo de lançamento não existe!"));dijit.byId(financeiroLancamentoCartao.idTipoLancText).attr("value","");dojo.byId(financeiroLancamentoCartao.idTipoLancValor).value="";}else{dijit.byId(financeiroLancamentoCartao.idTipoLancText).attr("value",_48.path);dojo.byId(financeiroLancamentoCartao.idTipoLancValor).value=_48.fn_tipo_lanc_id;}}});}return true;},changeTipoLancamento:function(_49){var _4a=_49.id;financeiroLancamentoCartao.idProjeto="projeto_"+parseInt(_4a.replace(/^[a-zA-Z_]+/g,""));financeiroLancamentoCartao.idTipoLancText="tipolan_"+parseInt(_4a.replace(/^[a-zA-Z_]+/g,""));financeiroLancamentoCartao.idTipoLancValor="vltplan_"+parseInt(_4a.replace(/^[a-zA-Z_]+/g,""));var _4b=dojo.byId(financeiroLancamentoCartao.idProjeto);if(_4b.value==""){objGeral.msgAlerta(objGeral.translate("Selecione projeto"));return false;}else{var _4c=objGeral.createDialog("/financeiro/lancamento-cartao/lancamentotipolancamento/",objGeral.translate("Selecione tipo de lançamento"),financeiroLancamentoCartao.initTree);}return true;}});var financeiroLancamentoCartao=new modulo.financeiro.lancamentocartao();}