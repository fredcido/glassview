/*
	Copyright (c) 2004-2010, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["modulo.financeiro.lancamento"]){dojo._hasResource["modulo.financeiro.lancamento"]=true;dojo.require("modulo.padrao.geral");dojo.require("modulo.padrao.grid");dojo.provide("modulo.financeiro.lancamento");dojo.declare("modulo.financeiro.lancamento",[modulo.padrao.geral,modulo.padrao.grid],{constructor:function(){this.noChangeTipoLancamento=false;this.noDoubleClickTree=null;},initGrid:function(){objGeral.loading(true);financeiroLancamento.gridHeader="#,"+objGeral.translate("Data")+","+objGeral.translate("Conta")+","+objGeral.translate("Nota Fiscal")+","+objGeral.translate("Fornecedor")+","+objGeral.translate("Valor");document.getElementById("gridFinanceiroLancamentoSaida").style.height=objGrid.gridHeight+"px";financeiroLancamento.gridSaida=new dhtmlXGridObject("gridFinanceiroLancamentoSaida");financeiroLancamento.gridSaida.setHeader(financeiroLancamento.gridHeader);financeiroLancamento.gridSaida.attachHeader("#rspan,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter");financeiroLancamento.gridSaida.setInitWidths(objGrid.idWidth+",*,300,200,200,200");financeiroLancamento.gridSaida.setColAlign("center,left,left,left,left,left");financeiroLancamento.gridSaida.setColTypes("ro,ro,ro,ro,ro,ro");financeiroLancamento.gridSaida.setColSorting("str,str,str,str,str,str");financeiroLancamento.gridSaida.setSkin(objGrid.theme);financeiroLancamento.gridSaida.enablePaging(true,objGrid.pagResults,objGrid.pagIndexes,"divpagFinanceiroLancamentoSaidaGrid",true,"divpagfinanceiroLancamentoSaida");financeiroLancamento.gridSaida.attachFooter(objGeral.translate("Lançamentos")+",#cspan,#cspan,{#stat_count},"+objGeral.translate("Total R$")+",{#stat_total}");financeiroLancamento.gridSaida.attachEvent("onRowDblClicked",financeiroLancamento.edit);financeiroLancamento.gridSaida.init();financeiroLancamento.gridSaida.load(baseUrl+"/financeiro/lancamento/list-saida/",dojo.hitch(objGeral,"loading",false),"json");document.getElementById("gridFinanceiroLancamentoEntrada").style.height=objGrid.gridHeight+"px";financeiroLancamento.gridEntrada=new dhtmlXGridObject("gridFinanceiroLancamentoEntrada");financeiroLancamento.gridEntrada.setHeader(financeiroLancamento.gridHeader);financeiroLancamento.gridEntrada.attachHeader("#rspan,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter");financeiroLancamento.gridEntrada.setInitWidths(objGrid.idWidth+",*,300,200,200,200");financeiroLancamento.gridEntrada.setColAlign("center,left,left,left,left,left");financeiroLancamento.gridEntrada.setColTypes("ro,ro,ro,ro,ro,ro");financeiroLancamento.gridEntrada.setColSorting("str,str,str,str,str,str");financeiroLancamento.gridEntrada.setSkin(objGrid.theme);financeiroLancamento.gridEntrada.enablePaging(true,objGrid.pagResults,objGrid.pagIndexes,"divpagFinanceiroLancamentoEntradaGrid",true,"divpagfinanceiroLancamentoEntrada");financeiroLancamento.gridEntrada.attachFooter(objGeral.translate("Lancamentos")+",#cspan,#cspan,{#stat_count},"+objGeral.translate("Total R$")+",{#stat_total}");financeiroLancamento.gridEntrada.attachEvent("onRowDblClicked",financeiroLancamento.edit);financeiroLancamento.gridEntrada.init();financeiroLancamento.gridEntrada.load(baseUrl+"/financeiro/lancamento/list-entrada/",dojo.hitch(objGeral,"loading",false),"json");dojo.subscribe("containerContas-selectChild",function(_1){financeiroLancamento.idAbaContainerContas=_1.id;switch(_1.id){case "transferencias":financeiroLancamento.initGridTransferencias();financeiroLancamento.blockButtons(true,["button_financeiro_lancamento_atualizar","button_financeiro_lancamento_salvaralterar"]);break;case "efetivados":financeiroLancamento.initGridEfetivados();financeiroLancamento.blockButtons(true,["button_financeiro_lancamento_atualizar","button_financeiro_lancamento_salvaralterar"]);break;default:financeiroLancamento.blockButtons(false);}});financeiroLancamento.idAbaContainerContas="contas-pagar";},blockButtons:function(_2,_3){$("#tabfinanceiro-lancamento .mainTela .toolbar > span").each(function(_4,_5){var _6=$(_5).attr("widgetid");if(objGeral.empty(_3)||$.inArray(_6,_3)<0){dijit.byNode(_5).setDisabled(_2);}});},initGridTransferencias:function(){if(!objGeral.empty(financeiroLancamento.gridTransferencia)){return;}objGeral.loading(true);gridHeader="#,"+objGeral.translate("Data")+","+objGeral.translate("Data efetivação")+","+objGeral.translate("Conta Origem")+","+objGeral.translate("Conta Destino")+","+objGeral.translate("Valor");document.getElementById("gridFinanceiroTransferencia").style.height=objGrid.gridHeight+"px";financeiroLancamento.gridTransferencia=new dhtmlXGridObject("gridFinanceiroTransferencia");financeiroLancamento.gridTransferencia.setHeader(gridHeader);financeiroLancamento.gridTransferencia.attachHeader("#rspan,#text_filter,#text_filter,#select_filter,#select_filter,#text_filter");financeiroLancamento.gridTransferencia.setInitWidths(objGrid.idWidth+",200,200,*,300,200");financeiroLancamento.gridTransferencia.setColAlign("center,left,left,left,left,right");financeiroLancamento.gridTransferencia.setColTypes("ro,ro,ro,ro,ro,ro");financeiroLancamento.gridTransferencia.setColSorting("str,str,str,str,str,str");financeiroLancamento.gridTransferencia.setSkin(objGrid.theme);financeiroLancamento.gridTransferencia.enablePaging(true,objGrid.pagResults,objGrid.pagIndexes,"divpagFinanceiroTransferenciaGrid",true,"gridFinanceiroTransferencia");financeiroLancamento.gridTransferencia.attachFooter(objGeral.translate("Transferências")+",#cspan,#cspan,{#stat_count},"+objGeral.translate("Total R$")+",{#stat_total}");financeiroLancamento.gridTransferencia.attachEvent("onRowDblClicked",financeiroLancamento.editTransferencia);financeiroLancamento.gridTransferencia.init();financeiroLancamento.gridTransferencia.load(baseUrl+"/financeiro/lancamento/list-transferencia/",dojo.hitch(objGeral,"loading",false),"json");},initGridEfetivados:function(){if(!objGeral.empty(financeiroLancamento.gridEfetivados)){return;}objGeral.loading(true);gridHeader="#,"+objGeral.translate("Data")+","+objGeral.translate("Data Efetivação")+","+objGeral.translate("Tipo")+","+objGeral.translate("Conta")+","+objGeral.translate("Nota Fiscal")+","+objGeral.translate("Fornecedor")+","+objGeral.translate("Valor");document.getElementById("gridFinanceiroEfetivados").style.height=objGrid.gridHeight+"px";financeiroLancamento.gridEfetivados=new dhtmlXGridObject("gridFinanceiroEfetivados");financeiroLancamento.gridEfetivados.setHeader(gridHeader);financeiroLancamento.gridEfetivados.attachHeader("#rspan,#text_filter,#text_filter,#select_filter,#select_filter,#text_filter,#text_filter,#text_filter");financeiroLancamento.gridEfetivados.setInitWidths(objGrid.idWidth+",*,120,150,200,200,250,200");financeiroLancamento.gridEfetivados.setColAlign("center,left,left,left,left,left,left,right");financeiroLancamento.gridEfetivados.setColTypes("ro,ro,ro,ro,ro,ro,ro,ro");financeiroLancamento.gridEfetivados.setColSorting("str,str,str,str,str,str,str,str");financeiroLancamento.gridEfetivados.setSkin(objGrid.theme);financeiroLancamento.gridEfetivados.enablePaging(true,objGrid.pagResults,objGrid.pagIndexes,"divpagFinanceiroEfetivadosGrid",true,"gridFinanceiroEfetivados");financeiroLancamento.gridEfetivados.attachFooter(objGeral.translate("Lançamentos")+",#cspan,#cspan,#cspan,#cspan,{#stat_count},"+objGeral.translate("Total R$")+",{#stat_total}");financeiroLancamento.gridEfetivados.attachEvent("onRowDblClicked",financeiroLancamento.detalhaEfetivados);financeiroLancamento.gridEfetivados.init();financeiroLancamento.gridEfetivados.load(baseUrl+"/financeiro/lancamento/list-efetivados/",dojo.hitch(objGeral,"loading",false),"json");},detalhaEfetivados:function(){var id=financeiroLancamento.gridEfetivados.getSelectedId();objGeral.createDialog("/financeiro/lancamento/edit/id/"+id+"/efetivado/1",objGeral.translate("Lançamento Efetivado"));},editTransferencia:function(){var id=financeiroLancamento.gridTransferencia.getSelectedId();if(objGeral.empty(id)){objGeral.msgAlerta(objGeral.translate("Selecione o item para edição."));return false;}objGeral.createDialog("/financeiro/lancamento/edit-transferencia/id/"+id,objGeral.translate("Transferência"));},editEfetivados:function(){var id=financeiroLancamento.gridEfetivados.getSelectedId();if(objGeral.empty(id)){objGeral.msgAlerta(objGeral.translate("Selecione o item para edição."));return false;}objGeral.createDialog("/financeiro/lancamento/pagamento/edit/1/id/"+id,objGeral.translate("Pagamento"));},novo:function(){objGeral.createDialog("/financeiro/lancamento/form/",objGeral.translate("Lançamento"),function(){switch(financeiroLancamento.idAbaContainerContas){case "contas-pagar":dijit.byId("lancamento-fn_lancamento_tipo").set("value","D");break;case "contas-receber":dijit.byId("lancamento-fn_lancamento_tipo").set("value","C");break;}});},edit:function(){switch(this.idAbaContainerContas){case "contas-pagar":if(!this.gridSaida.getSelectedId()){objGeral.msgAlerta(objGeral.translate("Selecione o item para edição."));return false;}this.valorSelecionado=this.gridSaida.getSelectedId();break;case "contas-receber":if(!this.gridEntrada.getSelectedId()){objGeral.msgAlerta(objGeral.translate("Selecione o item para edição."));return false;}this.valorSelecionado=this.gridEntrada.getSelectedId();break;case "transferencias":this.editTransferencia();return false;break;case "efetivados":this.editEfetivados();return false;break;}objGeral.createDialog("/financeiro/lancamento/edit/id/"+this.valorSelecionado,objGeral.translate("Lançamento"));return true;},removeTipoLancamento:function(_7,_8){if(!confirm(objGeral.translate("Deseja realmente remover este item?"))){return false;}var _9=dijit.byId("projeto_"+_7).get("value");var _a=document.getElementById("vltplan_"+_7).value;var _b=dojo.byId("lancamento-fn_lancamento_id").value;var _c={url:baseUrl+"/financeiro/lancamento/remove-lancamento-projeto/",data:{projeto_id:_9,fn_tipo_lanc_id:_a,fn_lancamento_id:_b},handle:"json",callback:function(_d){if(_d.status){objGeral.deleteRow($("#trid_"+_7));objGeral.msgSucesso(_d.description[0].message);}else{objGeral.msgErro(_d.description[0].message);}}};objGeral.buscaAjax(_c);return true;},addTipoLancamento:function(){objGeral.loading(true);var _e=financeiroLancamento.geraHashId();var _f=$("<tr>");var _10=new dojo.data.ItemFileReadStore({url:baseUrl+"/financeiro/lancamento/projeto"});var i;for(i=0;i<5;i++){_f.append($("<td>"));}for(i=0;i<5;i++){switch(i){case 0:var _11=new dijit.form.FilteringSelect({name:"lancamento[projeto_id][]",id:"projeto_"+_e,required:true,store:_10,style:"width: 200px",onChange:function(_12){var _13=parseInt($(this).attr("id").replace(/^[a-zA-Z_]+/g,""));dijit.byId("tipolan_"+_13).attr("value","");document.getElementById("vltplan_"+_13).value="";}});break;case 1:var _11=new dijit.form.ValidationTextBox({name:"lancamento[text_lancamento][]",id:"tipolan_"+_e,required:true,onChange:function(){financeiroLancamento.setChangeTipoLancamento(this);},labelAttr:"label",labelType:"html",style:"width: 200px"});var _14=document.createElement("input");_14.type="hidden";_14.name="lancamento[fn_tipo_lanc_id][]";_14.id="vltplan_"+_e;break;case 2:var _11=new dijit.form.Button({id:"buttonn_"+_e,onClick:function(){financeiroLancamento.changeTipoLancamento(this);},iconClass:"icon-toolbar-applicationformmagnify"});break;case 3:var _11=new dijit.form.CurrencyTextBox({name:"lancamento[fn_lanc_projeto_valor][]",id:"valorpr_"+_e,required:true,constraints:{min:0},currency:"R$ ",value:0,style:"width: 200px",onKeyUp:function(){financeiroLancamento.valorTotal();}});break;case 4:var _11=$("<div class=\"icon-toolbar-cancel\">").click(function(){if(!confirm(objGeral.translate("Deseja realmente remover este item?"))){return false;}objGeral.deleteRow($(this).parent().parent());financeiroLancamento.valorTotal();return true;}).attr("title",objGeral.translate("Remover Lançamento")).css({cursor:"pointer"});break;}if(_11){if(i!=4){_f.find("td").eq(i).append(_11.domNode);if(i==1){_f.find("td").eq(i).append(_14);}}else{_f.find("td").eq(i).append(_11);}}}$("#tbl-lancamento-tipo").append(_f);_10.fetch({onComplete:function(){objGeral.loading(false);}});},filteringTipoLancamento:function(_15){var _16=$(_15).attr("id").replace(/^[a-zA-Z_]+/g,"");var _17=dijit.byId($(_15).attr("id")).get("value");if(!objGeral.empty(_17)){objGeral.changeFilteringSelect("fn_tipo_lanc_id_"+_16,baseUrl+"/financeiro/lancamento/tipo-lancamento/id/",_17);}else{dijit.byId("fn_tipo_lanc_id_"+_16).set("value","");dijit.byId("fn_tipo_lanc_id_"+_16).set("disabled",true);}},valorTotal:function(){var _18=0;$("input[type=\"text\"]").each(function(i){var _19=$(this).attr("id");if(_19!=undefined){var _1a=_19.replace(/^valorpr_/,"");if(_19!=_1a){var _1b=dijit.byId(_19).get("value");_18+=!isNaN(_1b)?_1b:0;}}});if(dijit.byId("lancamento-fn_lancamento_valor")){dijit.byId("lancamento-fn_lancamento_valor").set("value",_18);}else{dijit.byId("lancamento-fn_forma_pgto_valor").set("value",_18);}},atualizarGrid:function(){switch(this.idAbaContainerContas){case "contas-pagar":objGeral.atualizarGrids([financeiroLancamento.gridSaida]);break;case "contas-receber":objGeral.atualizarGrids([financeiroLancamento.gridEntrada]);break;case "transferencias":objGeral.atualizarGrids([financeiroLancamento.gridTransferencia]);break;case "efetivados":objGeral.atualizarGrids([financeiroLancamento.gridEfetivados]);break;}},afterSubmit:function(_1c){if(!objGeral.empty(_1c.data)){switch(_1c.data.tela){case "A":almoxarifadoAtivo.novo();break;case "E":almoxarifadoEstoque.novo();break;}financeiroLancamento.atualizarGrid();}else{if(!objGeral.empty(_1c.refresh)){financeiroLancamento.atualizarGrid();}}},openCheque:function(){financeiroCheque.gridBuscaCheque();dijit.byId("dialogBuscaCheque").show();$("#divpagBuscaFinanceiroChequeGrid").children().remove();},stateElementEfetivar:function(_1d){return false;if("D"==_1d){dijit.byId("lancamento-fn_lancamento_efetivado").set("checked",false);dijit.byId("lancamento-fn_lancamento_efetivado").set("disabled",true);}else{dijit.byId("lancamento-fn_lancamento_efetivado").set("disabled",false);}},formTransferencia:function(){objGeral.createDialog("/financeiro/lancamento/transferencia/",objGeral.translate("Transferência"));},buscaContaDestino:function(_1e){if(!objGeral.empty(_1e)){var url=baseUrl+"/financeiro/lancamento/conta-destino/id/"+_1e;var _1f=new dojo.data.ItemFileReadStore({url:url});_1f.fetch({onComplete:function(){dijit.byId("conta_destino").set("disabled",false);}});dijit.byId("conta_destino").store=_1f;}else{dijit.byId("conta_destino").set("value","");dijit.byId("conta_destino").set("disabled",true);dijit.byId("saldo_conta_origem").set("value","");dijit.byId("saldo_conta_destino").set("value","");}},buscaSaldo:function(_20){var id=dijit.byId(_20).get("value");if(!objGeral.empty(id)){objGeral.buscaAjax({url:baseUrl+"/financeiro/lancamento/busca-saldo/",data:{fn_conta_id:id},handle:"json",callback:function(_21){dijit.byId("saldo_"+_20).set("value",parseFloat(_21.saldo));}});}else{dijit.byId("conta_destino").set("value","");dijit.byId("conta_destino").set("disabled",true);dijit.byId("saldo_conta_origem").set("value","");dijit.byId("saldo_conta_destino").set("value","");}},formPagamento:function(){var id;var _22;switch(financeiroLancamento.idAbaContainerContas){case "contas-receber":id=this.gridEntrada.getSelectedId();_22="C";break;case "contas-pagar":id=this.gridSaida.getSelectedId();_22="D";break;}if(objGeral.empty(id)){objGeral.msgAlerta(objGeral.translate("Selecione uma conta a pagar."));return false;}objGeral.createDialog("/financeiro/lancamento/pagamento/id/"+id,objGeral.translate("Efetivar"),function(){dojo.byId("fn_tipo_lancamento").value=_22;});},initTree:function(){financeiroLancamento.noDoubleClickTree=true;var _23=dijit.byId(financeiroLancamento.idProjeto);var id=_23.value;if(!objGeral.empty(this.treeView)){this.treeView.destroyRecursive(true);}objGeral.loading(true);var _24=new dojo.data.ItemFileWriteStore({url:baseUrl+"/financeiro/lancamento/treetipolancamento/id/"+id,hierarchical:true});_24.fetch({onComplete:function(){objGeral.loading(false);}});var _25=new modulo.custom.ForestStoreModel({store:_24,query:{type:"root"},childrenAttrs:["children"]},"store");this.treeView=new modulo.custom.TreeMenu({model:_25,showRoot:false,persist:true,dragThreshold:8,betweenThreshold:5,dndController:false,customIcons:false});dojo.connect(this.treeView,"onClick",dojo.hitch(financeiroLancamento,"setValuesTipoLancamento"));dojo.byId("tree-tipo-lancamento").appendChild(this.treeView.domNode);this.treeView.startup();},isExistId:function(_26){if(dojo.byId("projeto_"+_26)||dojo.byId("buttonn_"+_26)||dojo.byId("tipolan_"+_26)||dojo.byId("vltplan_"+_26)||dojo.byId("valorpr_"+_26)){return true;}else{return false;}},geraHashId:function(){var _27=new Date().getTime();while(financeiroLancamento.isExistId(_27)){_27=new Date().getTime();}return _27;},setChangeTipoLancamento:function(_28){if(financeiroLancamento.noChangeTipoLancamento){financeiroLancamento.noChangeTipoLancamento=false;return false;}var _29=_28.id;financeiroLancamento.idProjeto="projeto_"+parseInt(_29.replace(/^[a-zA-Z_]+/g,""));financeiroLancamento.idTipoLancText="tipolan_"+parseInt(_29.replace(/^[a-zA-Z_]+/g,""));financeiroLancamento.idTipoLancValor="vltplan_"+parseInt(_29.replace(/^[a-zA-Z_]+/g,""));var _2a=dijit.byId(financeiroLancamento.idProjeto).attr("value");if(_28.value==""){return false;}if(_2a==""){objGeral.msgAlerta(objGeral.translate("Selecione projeto"));dijit.byId(financeiroLancamento.idTipoLancText).attr("value","");dojo.byId(financeiroLancamento.idTipoLancValor).value="";return false;}else{objGeral.buscaAjax({url:baseUrl+"/financeiro/lancamento/busca-tipo-lancamento-codigo/",data:{fn_tipo_lanc_cod:_28.value,projeto_id:_2a},handle:"json",callback:function(_2b){financeiroLancamento.noChangeTipoLancamento=true;if(_2b==null){objGeral.msgAlerta(objGeral.translate("Código de tipo de lançamento não existe!"));dijit.byId(financeiroLancamento.idTipoLancText).attr("value","");dojo.byId(financeiroLancamento.idTipoLancValor).value="";}else{dijit.byId(financeiroLancamento.idTipoLancText).attr("value",_2b.path);dojo.byId(financeiroLancamento.idTipoLancValor).value=_2b.fn_tipo_lanc_id;}}});}return true;},changeTipoLancamento:function(_2c){var _2d=_2c.id;financeiroLancamento.idProjeto="projeto_"+parseInt(_2d.replace(/^[a-zA-Z_]+/g,""));financeiroLancamento.idTipoLancText="tipolan_"+parseInt(_2d.replace(/^[a-zA-Z_]+/g,""));financeiroLancamento.idTipoLancValor="vltplan_"+parseInt(_2d.replace(/^[a-zA-Z_]+/g,""));var _2e=dojo.byId(financeiroLancamento.idProjeto);if(_2e.value==""){objGeral.msgAlerta(objGeral.translate("Selecione projeto"));return false;}else{var _2f=objGeral.createDialog("/financeiro/lancamento/lancamentotipolancamento/",objGeral.translate("Selecione tipo de lançamento"),financeiroLancamento.initTree);}return true;},setValuesTipoLancamento:function(_30,_31){var _32=_30.id;_32=_32.toString();if(_32.split("_")[0]!="CAT"){financeiroLancamento.noChangeTipoLancamento=true;dijit.byId(financeiroLancamento.idTipoLancText).attr("value",_30.path);document.getElementById(financeiroLancamento.idTipoLancValor).value=_30.id;if(financeiroLancamento.noDoubleClickTree){objGeral.closeGenericDialog();financeiroLancamento.noDoubleClickTree=false;}}else{objGeral.msgAlerta(objGeral.translate("Você selecionou uma categoria, você deve selecionar um tipo de lançamento!"));}return true;},deletaLancamento:function(_33){if(confirm("Você está preste a excluir definitivamente um lançamento!\nDeseja continuar?")){_33=document.getElementById("lancamento-fn_lancamento_id").value;objGeral.buscaAjax({url:baseUrl+"/financeiro/lancamento/delet/",data:{identify:_33},handle:"json",callback:function(_34){if(_34.status){objGeral.closeGenericDialog();financeiroLancamento.atualizarGrid();objGeral.msgSucesso(_34.description[0].message);}else{objGeral.msgAlerta(_34.description[0].message);}}});}else{return false;}}});var financeiroLancamento=new modulo.financeiro.lancamento();}